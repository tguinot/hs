name: Publish Javadoc to GitHub Pages

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build and run tests
        run: mvn -B clean verify

      - name: Generate module Javadocs
        run: |
          mvn -B -pl probabilistic-random-gen,event-bus,throttler,window site

      - name: Assemble Pages artifact
        run: |
          mkdir -p public
          for module in probabilistic-random-gen event-bus throttler window; do
            # Copy Javadoc
            JAVADOC_DIR="$module/target/site/apidocs"
            if [ ! -d "$JAVADOC_DIR" ]; then
              echo "Expected Javadoc output missing for $module at $JAVADOC_DIR" >&2
              exit 1
            fi
            cp -R "$JAVADOC_DIR" "public/$module"
            
            # Copy JaCoCo coverage reports
            JACOCO_DIR="$module/target/site/jacoco"
            if [ -d "$JACOCO_DIR" ]; then
              mkdir -p "public/$module-coverage"
              cp -R "$JACOCO_DIR"/* "public/$module-coverage/"
              echo "âœ“ Copied coverage for $module"
            else
              echo "âš  No coverage report found for $module at $JACOCO_DIR"
            fi
          done

          cat <<'EOF' > public/index.html
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8"/>
            <title>HSBC Documentation</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 40px auto; padding: 0 20px; }
              h1 { color: #333; }
              h2 { color: #666; margin-top: 30px; }
              ul { list-style: none; padding: 0; }
              li { margin: 10px 0; }
              a { color: #0066cc; text-decoration: none; }
              a:hover { text-decoration: underline; }
              .module { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
              .links { display: flex; gap: 20px; }
            </style>
          </head>
          <body>
            <h1>HSBC Sample Projects</h1>
            
            <h2>API Documentation & Coverage</h2>
            
            <div class="module">
              <strong>Probabilistic Random Generator</strong>
              <div class="links">
                <a href="probabilistic-random-gen/index.html">ðŸ“š API Docs</a>
                <a href="probabilistic-random-gen-coverage/index.html">ðŸ“Š Coverage</a>
              </div>
            </div>
            
            <div class="module">
              <strong>Event Bus</strong>
              <div class="links">
                <a href="event-bus/index.html">ðŸ“š API Docs</a>
                <a href="event-bus-coverage/index.html">ðŸ“Š Coverage</a>
              </div>
            </div>
            
            <div class="module">
              <strong>Sliding Window Throttler</strong>
              <div class="links">
                <a href="throttler/index.html">ðŸ“š API Docs</a>
                <a href="throttler-coverage/index.html">ðŸ“Š Coverage</a>
              </div>
            </div>
            
            <div class="module">
              <strong>Sliding Window Statistics</strong>
              <div class="links">
                <a href="window/index.html">ðŸ“š API Docs</a>
                <a href="window-coverage/index.html">ðŸ“Š Coverage</a>
              </div>
            </div>
          </body>
          </html>
          EOF

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
